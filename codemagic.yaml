workflows:
  ios-workflow:
    name: iOS Build Workflow
    environment:
      groups:
        - app_credentials
      vars:
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner"
        flutter: "3.22.0"
    instance_type: mac_mini_m2
    scripts:
      - name: Set up Flutter
        script: |
          flutter precache --ios
          flutter pub get
          flutter --version
      
      - name: Nuclear cleanup option
        script: |
          echo "ðŸš€ Nuclear option: Regenerating iOS folder completely..."
          rm -rf ios
          flutter create --ios --org com.yourcompany . --overwrite
          flutter pub get
          echo "âœ… iOS folder regenerated successfully"
      
      - name: Clean and update iOS deployment target to 15.5
        script: |
          echo "Setting iOS deployment target to 15.5..."
          
          # Update Podfile to iOS 15.5
          sed -i '' 's/platform :ios, .*/platform :ios, '\''15.5'\''/' ios/Podfile
          
          # Update Info.plist - ADD or UPDATE MinimumOSVersion
          if ! /usr/libexec/PlistBuddy -c "Print :MinimumOSVersion" ios/Runner/Info.plist 2>/dev/null; then
              echo "Adding MinimumOSVersion key to Info.plist..."
              /usr/libexec/PlistBuddy -c "Add :MinimumOSVersion string 15.5" ios/Runner/Info.plist
          else
              echo "Updating existing MinimumOSVersion key..."
              /usr/libexec/PlistBuddy -c "Set :MinimumOSVersion 15.5" ios/Runner/Info.plist
          fi
          
          # Update project.pbxproj deployment target
          sed -i '' 's/IPHONEOS_DEPLOYMENT_TARGET = [^;]*;/IPHONEOS_DEPLOYMENT_TARGET = 15.5;/g' ios/Runner.xcodeproj/project.pbxproj
          
          echo "âœ… Deployment target updated to iOS 15.5"
      
      - name: Force pod cache cleanup and install
        script: |
          cd ios
          pod cache clean --all
          pod deintegrate
          pod repo update
          pod install --repo-update --verbose
          cd ..
      
      - name: Build iOS
        script: |
          flutter build ios --debug --no-codesign --verbose
      
      - name: Verify all settings
        script: |
          echo "=== VERIFYING DEPLOYMENT TARGET ==="
          echo "Podfile:"
          grep "platform :ios" ios/Podfile
          echo "Info.plist MinimumOSVersion:"
          /usr/libexec/PlistBuddy -c "Print :MinimumOSVersion" ios/Runner/Info.plist 2>/dev/null || echo "Key not found"
          echo "âœ… All settings verified for iOS 15.5"
    artifacts:
      - build/ios/iphoneos/*.app
